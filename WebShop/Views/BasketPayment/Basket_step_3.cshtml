@model WebShop.Models.DeliveryViewModel
@{
    Layout = "~/Views/Shared/_PersonalLayout.cshtml";
    ViewBag.Title = "Basket_step_3";
    var comment = SessionHelper.OrderMessage;
    decimal orderPrice = SessionHelper.OrderPrice;
    var savedAddresses = ViewBag.SavedAddresses as List<WebShop.Models.DeliveryViewModel> ?? new List<WebShop.Models.DeliveryViewModel>();
}

<main class="main-content">
    <!-- Восстановленная панель шагов -->
    <div class="order-steps-wrap text-center">
        <ul class="order-steps">
            <li class="order-steps__item">
                <svg class="icon icon-shopping-cart order-steps__icon">
                    <use href="~/assets/images/svg/symbol/sprite.svg#shopping-cart"></use>
                </svg><span class="order-steps__title">Корзина</span>
            </li>
            <li class="order-steps__item">
                <svg class="icon icon-wallet-strong order-steps__icon">
                    <use href="~/assets/images/svg/symbol/sprite.svg#wallet-strong"></use>
                </svg><span class="order-steps__title">Оплата</span>
            </li>
            <li class="order-steps__item is-current">
                <svg class="icon icon-lorry order-steps__icon">
                    <use href="~/assets/images/svg/symbol/sprite.svg#lorry"></use>
                </svg><span class="order-steps__title">Доставка</span>
            </li>
            <li class="order-steps__item">
                <svg class="icon icon-confirmation order-steps__icon">
                    <use href="~/assets/images/svg/symbol/sprite.svg#confirmation"></use>
                </svg><span class="order-steps__title">Завершение</span>
            </li>
        </ul>
    </div>

    <form class="add-address" method="POST" action="@Url.Action("Basket_step_4", "BasketPayment")" name="add-address">
        <input type="hidden" name="deliveryType" id="deliveryType" value="delivery" />
        <input type="hidden" name="selectedAddressId" id="selectedAddressId" value="" />

        <div class="tabs-section">
            <div class="tabs tabs--secondary">
                <div class="tabs__header">
                    <ul class="tabs__list">
                        <li class="tabs__item"><a class="tabs__link is-active" href="#section-1" name="deliveryType">Доставка на адрес</a></li>
                        <li class="tabs__item"><a class="tabs__link" href="#section-2" name="deliveryType">Самовывоз</a></li>
                    </ul>
                    <div class="tabs__panes">
                        <div class="tabs__tab-pane is-active">
                            <!-- Блок выбора сохраненных адресов -->
                            <div class="saved-addresses mb-4">
                                <h4>Выберите адрес доставки</h4>

                                @if (savedAddresses.Any())
                                {
                                    <div class="address-list">
                                        @foreach (var address in savedAddresses)
                                        {
                                            <div class="address-item">
                                                <label class="address-radio">
                                                    <input type="radio" name="addressRadio" value="@address.Id"
                                                           data-city="@address.City"
                                                           data-street="@address.Street"
                                                           data-house="@address.House"
                                                           data-block="@address.Block"
                                                           data-apartment="@address.Apartment" />
                                                    <span class="address-text">
                                                        @address.City, @address.Street, д.@address.House
                                                        @if (!string.IsNullOrEmpty(address.Block))
                                                        {<span>, корп.@address.Block</span>}
                                                        @if (!string.IsNullOrEmpty(address.Apartment))
                                                        {<span>, кв.@address.Apartment</span>}
                                                    </span>
                                                </label>
                                            </div>
                                        }
                                    </div>
                                    <div class="text-center mt-3">
                                        <a href="@Url.Action("Delivery", "Delivery")" class="btn btn-outline-primary">
                                            <i class="fas fa-plus"></i> Добавить новый адрес
                                        </a>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-info text-center">
                                        <p>У вас нет сохраненных адресов</p>
                                        <a href="@Url.Action("Delivery", "Delivery")" class="btn btn-primary">
                                            <i class="fas fa-plus"></i> Добавить адрес
                                        </a>
                                    </div>
                                }
                            </div>

                            <!-- Скрытые поля для адреса -->
                            <input type="hidden" name="userCity" id="user-city-location" value="" />
                            <input type="hidden" name="userStreet" id="user-street" value="" />
                            <input type="hidden" name="userHouse" id="user-house" value="" />
                            <input type="hidden" name="userBlock" id="user-box" value="" />
                            <input type="hidden" name="userAppartment" id="user-flat" value="" />
                        </div>

                        <div class="tabs__tab-pane">
                            <!-- Блок самовывоза (оставить как было) -->
                            <div class="location-desc">
                                <p>Для того, чтобы забрать свой заказ, Вам нужно явиться в наше представительство по адресу, указанному ниже.</p>
                                <p>Просим обратить внимание на время, с которого будет доступен заказ.</p>
                            </div>
                            <div class="location">
                                <div class="location__places">
                                    <div class="location__place"><img class="location__place-img" src="~/assets/images/general/garage-location-1.jpg" alt="location"></div>
                                    <div class="location__place"><img class="location__place-img" src="~/assets/images/general/garage-location-map.jpg" alt="location"></div>
                                </div>
                                <div class="location__details">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="location__detail">
                                                <div class="location__detail-heading">Адрес</div>
                                                <div class="location__detail-desc">MD-2011, Молдова, г. Кишинев, ул. Студенцилор, 9/9</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="location__detail">
                                                <div class="location__detail-heading">Телефоны</div>
                                                <dl>
                                                    <dt>Администрация</dt>
                                                    <dd><a href="tel:+37322815400">+373 79-637-411</a></dd>
                                                </dl>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="location__detail">
                                                <div class="location__detail-heading">График работы</div>
                                                <dl>
                                                    <dt>Пн-Пт</dt>
                                                    <dd>с 8:00 до 18:00</dd>
                                                    <dt>Суббота</dt>
                                                    <dd>с 8:00 до 15:00</dd>
                                                    <dt>Воскресенье</dt>
                                                    <dd>выходной</dd>
                                                </dl>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="order-footer d-none d-md-flex">
            <a class="btn btn--reverse" href="@Url.Action("Basket_step_2", "BasketPayment")">Назад</a>
            <input type="text" class="order-footer__message" value="@comment" name="orderMessage" />
            <div class="footer-summary-price">
                <div class="footer-summary-price__title">Сумма к оплате</div>
                <div class="footer-summary-price__value">@orderPrice <span>Лей</span></div>
            </div>
            <input type="submit" class="btn btn--main" value="Далее">
        </div>
    </form>
</main>

@section Styles {
    <style>
        .saved-addresses {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #dee2e6;
        }

        .address-list {
            margin-bottom: 10px;
        }

        .address-item {
            margin-bottom: 8px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .address-radio {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

            .address-radio input[type="radio"] {
                margin-right: 10px;
            }

        .address-text {
            flex: 1;
        }
    </style>
}

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Обработчик выбора адреса
            const addressRadios = document.querySelectorAll('input[name="addressRadio"]');
            addressRadios.forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.checked) {
                        document.getElementById('selectedAddressId').value = this.value;
                        document.getElementById('user-city-location').value = this.dataset.city;
                        document.getElementById('user-street').value = this.dataset.street;
                        document.getElementById('user-house').value = this.dataset.house;
                        document.getElementById('user-box').value = this.dataset.block || '';
                        document.getElementById('user-flat').value = this.dataset.apartment || '';
                    }
                });
            });

            // Обработчики для вкладок
            const tabs = document.querySelectorAll(".tabs__link");
            const deliveryTypeInput = document.getElementById("deliveryType");

            tabs.forEach((tab, index) => {
                tab.addEventListener("click", function (e) {
                    e.preventDefault();

                    // Активировать нужную вкладку
                    tabs.forEach(t => t.classList.remove("is-active"));
                    tab.classList.add("is-active");

                    const panes = document.querySelectorAll(".tabs__tab-pane");
                    panes.forEach(p => p.classList.remove("is-active"));
                    panes[index].classList.add("is-active");

                    deliveryTypeInput.value = index === 0 ? "delivery" : "pickup";
                });
            });

            // Валидация при отправке формы
            document.querySelector('form.add-address').addEventListener('submit', function (e) {
                if (deliveryTypeInput.value === 'delivery' && !document.querySelector('input[name="addressRadio"]:checked')) {
                    e.preventDefault();
                    alert('Пожалуйста, выберите адрес доставки');
                }
            });
        });
    </script>
}